
(c) Copyright 2015, 2016 Hewlett Packard Enterprise Development LP

network_interface
=================

_WARNING: This role can be dangerous to use. If you lose network connectivity
to your target host by incorrectly configuring your networking, you may be
unable to recover without physical access to the machine._

This role enables users to configure various network components on target
machines. The role can be used to configure:

- `Ethernet interfaces`
- `Bonded interfaces`
- `VLAN interfaces`
- `OVS Bridge interfaces`
- `Bridge interfaces`

and within each of those

- `Network routes`


Requirements
------------

This role requires Ansible 1.4 or higher, and platform requirements are listed
in the metadata file.

Role Variables
--------------

The variables that can be passed to this role and a brief description follows:

    # The list of ethernet interfaces to be added to the system
    network_ether_interfaces: []

    # The list of bonded interfaces to be added to the system
    network_bond_interfaces: []

    # The list of vlan_interfaces
    network_vlan_interfaces: []

    # The list of openvswitch bridges and ports
    ovs_bridge_interfaces: []

     # The list of bridge interfaces to be added to the system
     network_bridge_interfaces: []

NOTE: The attributes for each of these lists are shown below.
      Typically these lists are generated by the Configuration Processor and are
      created in host_vars for every host.

      M - mandatory, O - optional, D - deprecated

    network_*_interfaces:              These options are common for all interface types
     - device:                      M  name for the interface being defined
       bootproto:                   M  manual/static/dhcp[dhcp should not be used for HOS]
       address:                     O  IP address of this interface
       netmask:                     O  netmask for this interface (255.255.255.0 or 24)
                                          (address & netmask required for bootproto: static only)
       mtu:                         O  MTU size for this interface
       route:                       O  list of route triples (full triples required)
        - network:                  O  a.b.c.d
          netmask:                  O  255.255.255.0
          gateway:                  O  a.b.c.e - address of the gateway for this network/netmask
                                          (network & netmask of 0.0.0.0 implies use as system default gateway)
       routing_table:               O  name of routing table used by this interface
       gateway:                     O  gateway for this subnet (within routing_table)
       cidr:                        O  CIDR of this interface (v.w.x.y/z) (within routing_table)
       vips:                        O  list of VIP addresses on this interface (within routing_table)

    network_ether_interfaces:
       ovs_bridge:                  O  this interface is attached to this ovs_bridge
       pci_pt:                      O  this interface is dedicated to PCI passthrough
       sriov_only:                  O  this interface is dedicated to SR-IOV
    network_bond_interfaces:
       ovs_bridge:                  O  this interface is attached to this ovs_bridge
       bond_mode:                   M  bonding mode
       bond_miimon:                 D  include in bond_options as 'miimon'
       bond_slaves:                 M  sub-interfaces of this bond
       bond_primary:                O  primary sub-interface for the bond
       bond_options:                O  set of bonding options not including mode, slaves or primary

    network_vlan_interfaces:
       ovs_bridge:                  O  this interface is attached to this ovs_bridge
       vlanrawdevice:               M  which interface to put this VLAN on
       vlanid:                      M  VLAN-id to use

    ovs_bridge_interfaces:
       port:                        M  interface to attach to this bridge
       hwaddr:                      O  MAC address to set for this bridge
       dpdk_port: true              O  interface will be used as a dpdk device

    network_bridge_interfaces:      # not currently used by HOS, not documented

There is also an ansible variable defined that globally controls the generation
of disable LRO directives within capable devices.

This is defined in the Debian specific ansible vars.

       disable_lro: true            M  disable LRO for capable interfaces

All generated files as shown below are generated on the target system in the
directory: `/etc/network/interfaces.d/`


Examples
--------

### Non-bonded configuration outline
    -- br-vlan103                 ovs-bridge: no-IP+routing_table:EXTERNAL_VM
         +---vlan103              vlan:       no-IP
               +---eth3           inherited from system
    
    -- br-eth1                    ovs-bridge: static-IP+routing_table:MANAGEMENT+routes+vips
         +---eth1                 ether:      no-IP
    
    -- eth2                       ether:      static-IP+routing_table:HLM

#### Ansible variables: Within per-host host-vars
    network_ether_interfaces:
    -   address: 192.168.10.3
        bootproto: static
        cidr: 192.168.10.0/24
        device: eth2
        gateway: 192.168.10.1
        netmask: 24
        routing_table: HLM
    
    -   bootproto: manual
        device: eth1
        ovs_bridge: br-eth1
    
    network_vlan_interfaces:
    -   bootproto: manual
        device: vlan103
        ovs_bridge: br-vlan103
        vlanid: 103
        vlanrawdevice: eth3
    
    ovs_bridge_interfaces:
    -   bootproto: manual
        device: br-vlan103
        port: vlan103
        routing_table: EXTERNAL-VM
    
    -   address: 192.168.245.3
        bootproto: static
        cidr: 192.168.245.0/24
        device: br-eth1
        gateway: 192.168.245.1
        netmask: 24
        port: eth1
        route:
        -   gateway: 192.168.245.1
            netmask: 0.0.0.0
            network: 0.0.0.0
        routing_table: MANAGEMENT
        vips:
        - 192.168.245.9
        - 192.168.245.10

#### Generated files:
`/etc/network/interfaces.d/45-br-vlan103`

    # HELION-MANAGED - Managed by Helion - Do not edit
    allow-ovs br-vlan103
    iface br-vlan103 inet manual
      pre-up ovs-vsctl --timeout=5 -- --may-exist add-br br-vlan103 || true
      pre-up ip addr flush dev vlan103 || true
      pre-up ovs-vsctl --timeout=5 -- --may-exist add-port br-vlan103 vlan103 -- || true
      pre-up ifconfig vlan103 up || true
      down ovs-vsctl --timeout=5 -- --if-exists del-port br-vlan103 vlan103 -- || true

`/etc/network/interfaces.d/35-vlan103`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto vlan103
    iface vlan103 inet manual
      vlan-raw-device eth3
      pre-up ethtool -K eth3 lro off || true
      up ip link set vlan103 up || true

`/etc/network/interfaces.d/45-br-eth1`

    # HELION-MANAGED - Managed by Helion - Do not edit
    allow-ovs br-eth1
    iface br-eth1 inet static
      address 192.168.245.3
      netmask 24
      pre-up ovs-vsctl --timeout=5 -- --may-exist add-br br-eth1 || true
      pre-up ip addr flush dev eth1 || true
      pre-up ovs-vsctl --timeout=5 -- --may-exist add-port br-eth1 eth1 -- || true
      pre-up ifconfig eth1 up || true
      down ovs-vsctl --timeout=5 -- --if-exists del-port br-eth1 eth1 -- || true
      pre-up ip route delete default || true
      
      up route add -net 0.0.0.0  netmask 0.0.0.0 gw 192.168.245.1 dev br-eth1 || true
      down route delete -net 0.0.0.0 netmask 0.0.0.0 gw 192.168.245.1 dev br-eth1 || true
      up ip route add default via 192.168.245.1 table MANAGEMENT || true
      down ip route delete default via 192.168.245.1 table MANAGEMENT || true
      up ip route add 192.168.245.0/24 dev br-eth1 table MANAGEMENT || true
      down ip route delete 192.168.245.0/24 dev br-eth1 table MANAGEMENT || true
      up ip rule add from 192.168.245.3 table MANAGEMENT || true
      down ip rule delete from 192.168.245.3 table MANAGEMENT || true
      up ip rule add from 192.168.245.9 table MANAGEMENT || true
      down ip rule delete from 192.168.245.9 table MANAGEMENT || true
      up ip rule add from 192.168.245.10 table MANAGEMENT || true
      down ip rule delete from 192.168.245.10 table MANAGEMENT || true

`/etc/network/interfaces.d/25-eth1`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto eth1
    iface eth1 inet manual
      pre-up ethtool -K eth1 lro off || true
      up ip link set eth1 up || true

`/etc/network/interfaces.d/25-eth2`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto eth2
    iface eth2 inet static
      address 192.168.10.3
      netmask 24
      pre-up ethtool -K eth2 lro off || true
      
      up ip route add default via 192.168.10.1 table HLM || true
      down ip route delete default via 192.168.10.1 table HLM || true
      up ip route add 192.168.10.0/24 dev eth2 table HLM || true
      down ip route delete 192.168.10.0/24 dev eth2 table HLM || true
      up ip rule add from 192.168.10.3 table HLM || true
      down ip rule delete from 192.168.10.3 table HLM || true

### Bonded configuration outline
    -- br-vlan333                 ovs-bridge: no-IP
         +---vlan333              vlan:       no-IP
               +---bond0          bond:       see below
    
    -- vlan423                    vlan:       static-IP+routing_table:MGMT+routes+vips
         +---bond0                bond:       see below
    
    -- vlan429                    vlan:       static-IP+routing_table:EXTERNAL_API+vips
         +---bond0                bond:       see below
    
    -- vlan435                    vlan:       static-IP+routing_table:GUEST
         +---bond0                bond:       see below
    
    -- bond0                      bond:       no-IP. active-backup+miimon++updelay+downdelay+primary:hed4
         +---hed4                 ether:      slave+primary
         +---hed5                 ether:      slave

#### Ansible variables: Within per-host host-vars
    ovs_bridge_interfaces:
    -   bootproto: manual
        device: br-vlan333
        port: vlan333
        routing_table: EXTERNAL_VM
    
    network_vlan_interfaces:
    -   address: 10.241.107.34
        bootproto: static
        cidr: 10.241.107.32/28
        device: vlan429
        gateway: 10.241.107.33
        netmask: 28
        routing_table: EXTERNAL_API
        vips:
        - 10.241.107.37
        vlanid: 429
        vlanrawdevice: bond0
    
    -   bootproto: manual
        device: vlan333
        ovs_bridge: br-vlan333
        vlanid: 333
        vlanrawdevice: bond0
    
    -   address: 10.241.107.130
        bootproto: static
        cidr: 10.241.107.128/28
        device: vlan435
        gateway: 10.241.107.129
        netmask: 28
        routing_table: GUEST
        vlanid: 435
        vlanrawdevice: bond0
    
    -   address: 10.241.103.2
        bootproto: static
        cidr: 10.241.103.0/24
        device: vlan423
        gateway: 10.241.103.1
        netmask: 24
        route:
        -   gateway: 10.241.103.1
            netmask: 0.0.0.0
            network: 0.0.0.0
        routing_table: MGMT
        vips:
        - 10.241.103.15
        vlanid: 423
        vlanrawdevice: bond0
    
    network_bond_interfaces:
    -   bond_mode: active-backup
        bond_options:
            miimon: 200
            updelay: 200
            downdelay: 200
        bond_slaves:
        - hed4
        - hed5
        bond_primary: hed4
        bootproto: manual
        device: bond0

#### Generated files:
`/etc/network/interfaces.d/45-br-vlan333`

    # HELION-MANAGED - Managed by Helion - Do not edit
    allow-ovs br-vlan333
    iface br-vlan333 inet manual
      pre-up ovs-vsctl --timeout=5 -- --may-exist add-br br-vlan103 || true
      pre-up ip addr flush dev vlan333 || true
      up ovs-vsctl --timeout=5 -- --may-exist add-port br-vlan333 vlan333 -- || true
      pre-up ifconfig vlan333 up || true
      down ovs-vsctl --timeout=5 -- --if-exists del-port br-vlan333 vlan333 -- || true
    
`/etc/network/interfaces.d/35-vlan333`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto vlan333
    iface vlan333 inet manual
      vlan-raw-device bond0
      up ip link set vlan333 up || true

`/etc/network/interfaces.d/35-vlan423`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto vlan423
    iface vlan423 inet static
      address 10.241.103.2
      netmask 24
      vlan-raw-device bond0
      pre-up ip route delete default || true
      
      up route add -net 0.0.0.0  netmask 0.0.0.0 gw 10.241.103.1 dev vlan423 || true
      down route delete -net 0.0.0.0 netmask 0.0.0.0 gw 10.241.103.1 dev vlan423 || true
      up ip route add default via 10.241.103.1 table MGMT || true
      down ip route delete default via 10.241.103.1 table MGMT || true
      up ip route add 10.241.103.0/24 dev vlan423 table MGMT || true
      down ip route delete 10.241.103.0/24 dev vlan423 table MGMT || true
      up ip rule add from 10.241.103.2 table MGMT || true
      down ip rule delete from 10.241.103.2 table MGMT || true

`/etc/network/interfaces.d/35-vlan429`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto vlan429
    iface vlan429 inet static
      address 10.241.107.34
      netmask 28
      vlan-raw-device bond0
      
      up ip route add default via 10.241.107.33 table EXTERNAL_API || true
      down ip route delete default via 10.241.107.33 table EXTERNAL_API || true
      up ip route add 10.241.107.32/28 dev vlan429 table EXTERNAL_API || true
      down ip route delete 10.241.107.32/28 dev vlan429 table EXTERNAL_API || true
      up ip rule add from 10.241.107.34 table EXTERNAL_API || true
      down ip rule delete from 10.241.107.34 table EXTERNAL_API || true

`/etc/network/interfaces.d/35-vlan435`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto vlan435
    iface vlan435 inet static
      address 10.241.107.130
      netmask 28
      vlan-raw-device bond0
      
      up ip route add default via 10.241.107.129 table GUEST || true
      down ip route delete default via 10.241.107.129 table GUEST || true
      up ip route add 10.241.107.128/28 dev vlan435 table GUEST || true
      down ip route delete 10.241.107.128/28 dev vlan435 table GUEST || true
      up ip rule add from 10.241.107.130 table GUEST || true
      down ip rule delete from 10.241.107.130 table GUEST || true

`/etc/network/interfaces.d/15-bond0`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto bond0
    iface bond0 inet manual
      bond-mode active-backup
      bond-slaves none
      bond-miimon 200
      bond-updelay 200
      bond-downdelay 200

`/etc/network/interfaces.d/25-hed4`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto hed4
    iface hed4 inet manual
      bond-master bond0
      bond-primary hed4
      pre-up ethtool -K hed4 lro off || true
      pre-up ip addr flush dev hed4 || true
      up ip link set hed4 up || true

`/etc/network/interfaces.d/25-hed5`

    # HELION-MANAGED - Managed by Helion - Do not edit
    auto hed5
    iface hed5 inet manual
      bond-master bond0
      pre-up ethtool -K hed5 lro off || true
      pre-up ip addr flush dev hed5 || true
      up ip link set hed5 up || true

--------------------------------------------------------------------------------
Note: Ansible needs network connectivity throughout the playbook process, you
may need to have a control interface that you do *not* modify using this
method so that Ansible has a stable connection to configure the target
systems.

Dependencies
------------

None

License
-------

BSD

Author Information
------------------

Benno Joy

Hewlett Packard Enterprise Development LP

